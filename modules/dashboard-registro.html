<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Control y Registro - CUE Movilidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-[#f0f4f8] font-['Inter']">

    <nav class="bg-white border-b-4 border-green-700 shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="../assets/img/logo_avh.png" alt="Logo CUE" class="h-10">
                <h1 class="font-bold text-green-800 border-l pl-4 ml-2">Control y Registro Académico</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p id="userNameDisplay" class="text-sm font-bold text-[#03045e] leading-tight">Usuario</p>
                    <p id="userRoleDisplay" class="text-[10px] text-gray-500 uppercase font-bold">Rol</p>
                </div>
                <button onclick="AuthService.logout()" class="text-gray-400 hover:text-red-500 p-2 bg-gray-50 rounded-full hover:bg-red-50 transition" title="Cerrar Sesión">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto mt-8 px-6 pb-12">
        <div class="flex flex-wrap justify-between items-end gap-4 mb-6 border-b pb-4">
            <div>
                <h2 class="text-2xl font-bold text-[#03045e]">Gestión Académica de Movilidad (REQ-16 a REQ-18)</h2>
                <p class="text-gray-500 text-sm">Entrantes por matricular (Plantilla Q10), exportación y certificados.</p>
            </div>
            <button type="button" id="btnExportQ10" onclick="exportarPlantillaQ10()" class="bg-green-700 text-white px-4 py-2 rounded-lg text-sm font-bold hover:bg-green-800 transition flex items-center gap-2 shadow-sm">
                <i data-lucide="file-spreadsheet" class="w-4 h-4"></i> Exportar Plantilla Q10
            </button>
        </div>

        <div class="grid grid-cols-1 gap-8">
            <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden flex flex-col">
                <div class="bg-gray-50 p-4 border-b flex justify-between items-center">
                    <h3 class="font-bold text-[#03045e] flex items-center gap-2">
                        <i data-lucide="user-plus" class="w-5 h-5 text-green-700"></i> Entrantes por Matricular (Plantilla Q10)
                    </h3>
                </div>
                <div class="p-4 flex-grow overflow-y-auto max-h-[600px]">
                    <p class="text-xs text-gray-500 mb-4">Estudiantes externos aprobados por Dirección ANI. Requieren creación de usuario en Q10 y asignación de materias.</p>
                    <div id="matriculasContainer" class="space-y-4"></div>
                </div>
            </div>

        </div>
    </main>

    <script src="https://cdn.sheetjs.com/xlsx-0.20.1/package/dist/xlsx.full.min.js"></script>
    <script src="../assets/js/auth.js"></script>
    <script>
        function escapeHtml(str) {
            if (str == null) return '';
            return String(str)
                .replace(/&/g, '&amp;')
                .replace(/</g, '&lt;')
                .replace(/>/g, '&gt;')
                .replace(/"/g, '&quot;')
                .replace(/'/g, '&#039;');
        }
        document.addEventListener('DOMContentLoaded', () => {
            const user = AuthService.checkAuth({ redirectTo: '../index-sistema.html' });
            if (!user || user.role.code !== 'REGISTRO') {
                alert("Acceso denegado. Se requiere perfil de Control y Registro.");
                window.location.href = '../index-sistema.html';
                return;
            }
            
            document.getElementById('userNameDisplay').textContent = user.name;
            document.getElementById('userRoleDisplay').textContent = user.role.name;

            loadRegistroDashboards();
            lucide.createIcons();
        });

        function loadRegistroDashboards() {
            const matriculasContainer = document.getElementById('matriculasContainer');
            matriculasContainer.innerHTML = '';

            // Mocks de base de datos: estudiantes externos por matricular (datos completos Q10)
            const mockRequests = [
                { 
                    id: 'REQ-XM1',
                    date: '2026-02-10',
                    type: 'Intercambio Académico (Semestre - Asignaturas)',
                    dir: 'ENTRANTE',
                    status: 'PENDIENTE_MATRICULA',
                    userEmail: 'carlos.extern@unam.mx',
                    externoFOIN012: {
                        primerNombre: 'Carlos',
                        segundoNombre: 'Alberto',
                        primerApellido: 'Méndez',
                        segundoApellido: 'López',
                        sexo: 'M',
                        direccion: 'Calle 10 # 20-30',
                        departamento: 'Quindío',
                        municipio: 'Armenia',
                        tipoDoc: 'CC',
                        numDoc: '80123456',
                        fecNacimiento: '1998-05-20',
                        celular: '3009998877',
                        correo: 'carlos.extern@unam.mx',
                        actividadesMaterias: 'Cursar Ingeniería de Software II, Bases de Datos Avanzadas y Ética Profesional.'
                    }
                },
                { 
                    id: 'REQ-XM2',
                    date: '2026-02-12',
                    type: 'Curso Corto',
                    dir: 'ENTRANTE',
                    status: 'PENDIENTE_MATRICULA',
                    userEmail: 'maria.ext@ula.ve',
                    externoFOIN012: {
                        primerNombre: 'María',
                        segundoNombre: 'Fernanda',
                        primerApellido: 'García',
                        segundoApellido: 'Sánchez',
                        sexo: 'F',
                        direccion: 'Av. Principal 45',
                        departamento: 'Valencia',
                        municipio: 'Valencia',
                        tipoDoc: 'PA',
                        numDoc: 'V12345678',
                        fecNacimiento: '1997-03-15',
                        celular: '3012223344',
                        correo: 'maria.ext@ula.ve',
                        actividadesMaterias: 'Curso corto en Innovación Empresarial y Emprendimiento.'
                    }
                },
                { 
                    id: 'REQ-XM3',
                    date: '2026-02-15',
                    type: 'Estancia Investigación',
                    dir: 'ENTRANTE',
                    status: 'PENDIENTE_MATRICULA',
                    userEmail: 'juan.ext@uni.edu.pe',
                    externoFOIN012: {
                        primerNombre: 'Juan',
                        segundoNombre: '',
                        primerApellido: 'Pérez',
                        segundoApellido: 'Ruiz',
                        sexo: 'M',
                        direccion: 'Jr. Las Flores 123',
                        departamento: 'Lima',
                        municipio: 'Lima',
                        tipoDoc: 'CE',
                        numDoc: '45678901',
                        fecNacimiento: '1996-11-02',
                        celular: '3025556677',
                        correo: 'juan.ext@uni.edu.pe',
                        actividadesMaterias: 'Estancia de investigación en laboratorio de Ingeniería de Software.'
                    }
                }
            ];

            let localReqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            const allReqs = [...mockRequests];
            
            // Consolidar storage y mocks
            localReqs.forEach(lr => { 
                const index = allReqs.findIndex(ar => ar.id === lr.id);
                if(index > -1) {
                    // Actualizar si ya existe (para atrapar los certificados pedidos en esta sesión)
                    allReqs[index] = {...allReqs[index], ...lr};
                } else {
                    allReqs.push(lr); 
                }
            });

            // REQ-16: Visor entrantes con campos separados (Plantilla Q10)
            const matriculas = allReqs.filter(req => req.status === 'PENDIENTE_MATRICULA' && req.dir === 'ENTRANTE');
            if(matriculas.length === 0) {
                matriculasContainer.innerHTML = `<p class="text-center text-sm text-gray-400 italic py-8">Bandeja al día. No hay entrantes pendientes.</p>`;
            } else {
                matriculas.forEach(req => {
                    const ext = req.externoFOIN012 || {};
                    const v = (x) => (x === undefined || x === null || x === '') ? '—' : String(x);
                    const safeId = (req.id || '').replace(/'/g, "\\'");
                    const cardContent = ext.primerNombre != null || ext.primerApellido != null
                        ? `
                            <div class="grid grid-cols-2 gap-x-4 gap-y-1 text-xs text-gray-700 mb-3">
                                <span><strong class="text-gray-500">Primer nombre:</strong> ${v(ext.primerNombre)}</span>
                                <span><strong class="text-gray-500">Segundo nombre:</strong> ${v(ext.segundoNombre)}</span>
                                <span><strong class="text-gray-500">Primer apellido:</strong> ${v(ext.primerApellido)}</span>
                                <span><strong class="text-gray-500">Segundo apellido:</strong> ${v(ext.segundoApellido)}</span>
                                <span><strong class="text-gray-500">Sexo:</strong> ${v(ext.sexo)}</span>
                                <span><strong class="text-gray-500">Documento:</strong> ${v(ext.tipoDoc)} ${v(ext.numDoc)}</span>
                                <span class="col-span-2"><strong class="text-gray-500">Dirección:</strong> ${v(ext.direccion)}</span>
                                <span><strong class="text-gray-500">Departamento:</strong> ${v(ext.departamento)}</span>
                                <span><strong class="text-gray-500">Municipio:</strong> ${v(ext.municipio)}</span>
                                <span class="col-span-2"><strong class="text-gray-500">Correo:</strong> ${v(ext.correo) || v(req.userEmail)}</span>
                            </div>
                            <div class="text-sm text-gray-700 mb-4">
                                <span class="block font-bold text-xs text-gray-400 uppercase mb-1">Actividades a realizar / materias a cursar</span>
                                <div class="bg-gray-50 p-2 rounded border text-xs whitespace-pre-line">${v(ext.actividadesMaterias) || req.materias || '—'}</div>
                            </div>
                        `
                        : `
                            <div class="text-sm text-gray-700 mb-4">
                                <p class="text-xs text-gray-500"><strong>Correo:</strong> ${escapeHtml(req.userEmail)}</p>
                                <span class="block font-bold text-xs text-gray-400 uppercase mb-1 mt-2">Actividades / materias a cursar</span>
                                <div class="bg-gray-50 p-2 rounded border text-xs whitespace-pre-line">${escapeHtml(req.materias || '—')}</div>
                            </div>
                        `;
                    matriculasContainer.innerHTML += `
                        <div class="border rounded-lg p-4 bg-white shadow-sm border-l-4 border-green-500">
                            <div class="flex justify-between items-start border-b pb-2 mb-3">
                                <div>
                                    <span class="font-mono text-xs font-bold text-[#03045e]">${escapeHtml(req.id)}</span>
                                    <p class="text-xs text-gray-500 mt-0.5">${escapeHtml(req.type)}</p>
                                </div>
                                <span class="bg-yellow-100 text-yellow-800 text-[10px] px-2 py-1 rounded font-bold uppercase">Por Matricular</span>
                            </div>
                            ${cardContent}
                            <button onclick="confirmMatricula('${safeId}')" class="w-full bg-green-600 text-white py-2 rounded text-xs font-bold hover:bg-green-700 transition flex items-center justify-center gap-2">
                                <i data-lucide="check-circle" class="w-4 h-4"></i> Confirmar Matrícula
                            </button>
                        </div>
                    `;
                });
            }

            lucide.createIcons();
        }

        // Acciones Funcionales
        function confirmMatricula(id) {
            if (!confirm("¿Confirma que este estudiante ha sido creado y matriculado exitosamente en el sistema de información institucional (Q10)?")) {
                return;
            }

            const codigoQ10 = prompt("Ingrese el código Q10 asignado al estudiante:", `Q10-${id}`);
            if (!codigoQ10) {
                alert("Operación cancelada. Debe registrar un código Q10 para continuar.");
                return;
            }

            let reqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            reqs = reqs.map(req => {
                if (req.id === id) {
                    const registroInfo = {
                        ...(req.registroInfo || {}),
                        codigoQ10,
                        fechaCreacionQ10: new Date().toISOString(),
                        estadoCertificado: 'PENDIENTE',
                        tipoCertificado: 'MATRICULA'
                    };
                    return {
                        ...req,
                        status: 'MOVILIDAD_ACTIVA',
                        registroInfo
                    };
                }
                return req;
            });
            localStorage.setItem('CUE_MY_REQUESTS', JSON.stringify(reqs));
            
            alert("Estudiante Entrante matriculado.\nEl estado ha cambiado a MOVILIDAD ACTIVA y se ha registrado la información de Q10. Se ha notificado a Dirección ANI y al estudiante.");
            loadRegistroDashboards();
        }

        // REQ-17: Exportar Plantilla Q10 (.xlsx). Datos desde fila 8; columnas en orden estricto.
        function exportarPlantillaQ10() {
            const allReqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            const entrantes = allReqs.filter(r => r.dir === 'ENTRANTE' && (r.status === 'PENDIENTE_MATRICULA' || r.status === 'MOVILIDAD_ACTIVA') && r.externoFOIN012);
            if (entrantes.length === 0) {
                alert('No hay entrantes con datos Q10 para exportar. Deben existir solicitudes entrantes con datos personales completos.');
                return;
            }
            const headers = [
                'Primer nombre', 'Segundo nombre', 'Primer apellido', 'Segundo apellido',
                'Tipo documento', 'Número identificación', 'Sexo', 'Fecha nacimiento',
                'Teléfono', 'Celular', 'Email', 'Dirección',
                'País dirección', 'Departamento dirección', 'Municipio dirección'
            ];
            const rows = entrantes.map(r => {
                const e = r.externoFOIN012 || {};
                return [
                    e.primerNombre || '',
                    e.segundoNombre || '',
                    e.primerApellido || '',
                    e.segundoApellido || '',
                    e.tipoDoc || '',
                    e.numDoc || '',
                    e.sexo || '',
                    e.fecNacimiento || '',
                    e.contactoTelefono || e.celular || '',
                    e.celular || '',
                    e.correo || r.userEmail || '',
                    e.direccion || '',
                    e.pais || '',
                    e.departamento || '',
                    e.municipio || ''
                ];
            });
            const data = [];
            for (let i = 0; i < 7; i++) data.push([]);
            data[0][0] = 'Plantilla Q10 - CUE Movilidad Académica';
            data.push(headers);
            rows.forEach(row => data.push(row));

            const wb = XLSX.utils.book_new();
            const ws = XLSX.utils.aoa_to_sheet(data);
            XLSX.utils.book_append_sheet(wb, ws, 'Q10');
            const filename = 'Plantilla_Q10_' + new Date().toISOString().slice(0, 10) + '.xlsx';
            XLSX.writeFile(wb, filename);
            alert('Archivo "' + filename + '" generado. Los datos dinámicos comienzan en la fila 8.');
        }

        function dispatchCertificado(id) {
            if(confirm("¿Confirma que el documento adjunto es el correcto y desea enviarlo al solicitante?")) {
                let reqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
                reqs = reqs.map(req => {
                    if (req.id === id) {
                        const updated = {
                            ...req,
                            certReady: true,
                            certStatus: 'ENTREGADO'
                        };
                        if (updated.registroInfo) {
                            updated.registroInfo = {
                                ...updated.registroInfo,
                                estadoCertificado: 'ENTREGADO'
                            };
                        }
                        return updated;
                    }
                    return req;
                });
                localStorage.setItem('CUE_MY_REQUESTS', JSON.stringify(reqs));
                
                alert("Certificado despachado.\nEl documento ya está disponible para su descarga en el panel del usuario.");
                loadRegistroDashboards();
            }
        }
    </script>
</body>
</html>