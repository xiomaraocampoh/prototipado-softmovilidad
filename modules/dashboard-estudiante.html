<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Mi Panel - CUE Movilidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>
<body class="bg-[#f0f4f8] font-['Inter']">

    <nav class="bg-white border-b-4 border-[#03045e] shadow-md sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-6 h-16 flex justify-between items-center">
            <div class="flex items-center gap-3">
                <img src="../assets/img/logo_avh.png" alt="Logo CUE" class="h-10">
                <h1 class="font-bold text-[#03045e] border-l pl-4 ml-2">Portal del Solicitante</h1>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right hidden md:block">
                    <p id="userNameDisplay" class="text-sm font-bold text-[#03045e] leading-tight">Usuario</p>
                    <p id="userRoleDisplay" class="text-[10px] text-gray-500 uppercase font-bold">Rol</p>
                </div>
                <button onclick="AuthService.logout()" class="text-gray-400 hover:text-red-500 p-2 bg-gray-50 rounded-full hover:bg-red-50 transition" title="Cerrar Sesión">
                    <i data-lucide="log-out" class="w-5 h-5"></i>
                </button>
            </div>
        </div>
    </nav>

    <main class="max-w-7xl mx-auto mt-8 px-6 pb-12">
        <div class="flex justify-between items-end mb-6 border-b pb-4">
            <div>
                <h2 class="text-2xl font-bold text-[#03045e]">Mis Trámites de Movilidad</h2>
                <p class="text-gray-500 text-sm">Haga seguimiento a sus solicitudes y certificados.</p>
            </div>
            <div class="flex gap-2">
                <button onclick="openProfileModal()" class="bg-white border-2 border-[#03045e] text-[#03045e] px-4 py-2 rounded font-bold hover:bg-gray-50 transition flex items-center gap-2 text-sm">
                    <i data-lucide="user" class="w-4 h-4"></i> Mi Perfil
                </button>
                <button onclick="openReqsModal()" class="bg-white border-2 border-[#0077b6] text-[#0077b6] px-4 py-2 rounded font-bold hover:bg-blue-50 transition flex items-center gap-2 text-sm">
                    <i data-lucide="info" class="w-4 h-4"></i> Guía de Requisitos
                </button>
                <a href="mobility-wizard.html" class="bg-[#0077b6] text-white px-6 py-2 rounded font-bold hover:bg-[#03045e] transition shadow flex items-center gap-2 text-sm">
                    <i data-lucide="plus-circle" class="w-4 h-4"></i> Nueva Postulación
                </a>
            </div>
        </div>

        <div class="bg-white rounded shadow-sm border border-gray-200 overflow-hidden">
            <table class="w-full text-left border-collapse">
                <thead class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-bold">
                    <tr>
                        <th class="p-4 w-32">Radicado</th>
                        <th class="p-4">Tipo y Destino</th>
                        <th class="p-4">Fecha</th>
                        <th class="p-4">Estado Actual</th>
                        <th class="p-4 text-center w-48">Acción</th>
                    </tr>
                </thead>
                <tbody id="requestsTableBody" class="divide-y divide-gray-100 text-sm">
                    </tbody>
            </table>
        </div>
    </main>

    <div id="reqsModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded shadow-xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[90vh]">
            <div class="bg-[#0077b6] p-4 flex justify-between items-center text-white">
                <h3 class="font-bold flex items-center gap-2"><i data-lucide="file-check" class="w-5 h-5"></i> Guía de Requisitos por Tipo de Movilidad</h3>
                <button onclick="document.getElementById('reqsModal').classList.add('hidden')" class="text-blue-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto space-y-4">
                <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                    <div class="border-l-4 border-[#03045e] bg-gray-50 p-4 rounded shadow-sm">
                        <h4 class="font-bold text-[#03045e] mb-2 text-sm">Salida Académica / Eventos (Profesor)</h4>
                        <ul class="text-xs text-gray-700 list-disc pl-5 space-y-1">
                            <li><strong>Aplica para:</strong> Visita o Salida Académica guiada por un profesor.</li>
                            <li><strong>Fase 1:</strong> Registro de información y lista de participantes.</li>
                            <li><strong>SST (Interno):</strong> Validación de SOAT, Tecnomecánica, Pólizas y Licencia del conductor.</li>
                        </ul>
                    </div>
                    <div class="border-l-4 border-blue-400 bg-blue-50 p-4 rounded shadow-sm">
                        <h4 class="font-bold text-blue-800 mb-2 text-sm">Intercambio Académico</h4>
                        <ul class="text-xs text-gray-700 list-disc pl-5 space-y-1">
                            <li><strong>Fase 1 (Postulación):</strong> Documento de Identidad y Carta de Motivación (Entrantes adjuntan notas).</li>
                            <li><strong>Fase 2 (documentación):</strong> Carta de Aceptación Oficial.</li>
                            <li><strong>Internacional:</strong> Pasaporte y Seguro Médico Internacional.</li>
                        </ul>
                    </div>
                    <div class="border-l-4 border-purple-400 bg-purple-50 p-4 rounded shadow-sm">
                        <h4 class="font-bold text-purple-800 mb-2 text-sm">Prácticas y Rotaciones</h4>
                        <ul class="text-xs text-gray-700 list-disc pl-5 space-y-1">
                            <li><strong>Fase 1:</strong> Documento de Identidad y descripción de labores.</li>
                            <li><strong>Fase 2:</strong> Carta de aceptación de la empresa u hospital.</li>
                            <li><strong>Obligatorio:</strong> Certificado de afiliación a ARL.</li>
                        </ul>
                    </div>
                    <div class="border-l-4 border-teal-400 bg-teal-50 p-4 rounded shadow-sm">
                        <h4 class="font-bold text-teal-800 mb-2 text-sm">Formación Continua e Investigación</h4>
                        <ul class="text-xs text-gray-700 list-disc pl-5 space-y-1">
                            <li><strong>Aplica para:</strong> Diplomados, Cursos, Estancias de Investigación.</li>
                            <li><strong>Investigación:</strong> Carta de aceptación del Tutor/Investigador.</li>
                            <li><strong>Cursos:</strong> Soporte de inscripción o invitación.</li>
                        </ul>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div id="profileModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded shadow-xl w-full max-w-4xl overflow-hidden flex flex-col max-h-[95vh]">
            <div class="bg-[#03045e] p-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold flex items-center gap-2"><i data-lucide="user" class="w-5 h-5"></i> Mi Perfil de Solicitante</h3>
                <button onclick="document.getElementById('profileModal').classList.add('hidden')" class="text-gray-300 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto">
                <div id="profileAlertBox" class="text-sm p-3 rounded mb-6 border"></div>
                
                <form class="space-y-6">
                    <div>
                        <h4 class="font-bold text-[#03045e] text-sm border-b pb-2 mb-4">Información Personal y Académica</h4>
                        <div class="grid grid-cols-1 md:grid-cols-3 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Nombres</label>
                                <input type="text" id="profNombres" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Apellidos</label>
                                <input type="text" id="profApellidos" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Tipo de Documento</label>
                                <select id="profTipoDoc" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                                    <option value="CC">Cédula de Ciudadanía</option>
                                    <option value="TI">Tarjeta de Identidad</option>
                                    <option value="CE">Cédula de Extranjería</option>
                                    <option value="PA">Pasaporte</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Número de Documento</label>
                                <input type="text" id="profNumDoc" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Fecha de Expedición</label>
                                <input type="date" id="profExpDoc" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Fecha de Nacimiento</label>
                                <input type="date" id="profFecNac" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Nacionalidad</label>
                                <input type="text" id="profNacionalidad" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Número de Celular</label>
                                <input type="tel" id="profCelular" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div id="extRoleContainer" class="hidden">
                                <label class="block text-xs font-bold text-gray-600 mb-1">Rol de Solicitante Externo</label>
                                <select id="profRolExt" class="w-full border p-2 rounded text-sm focus:outline-none focus:border-[#03045e]">
                                    <option value="Estudiante">Estudiante</option>
                                    <option value="Profesor">Profesor / Investigador</option>
                                    <option value="Administrativo">Administrativo</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Semestre Actual</label>
                                <input type="number" id="profSemestre" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Promedio Acumulado</label>
                                <input type="number" step="0.1" id="profPromedio" class="w-full border p-2 rounded text-sm focus:outline-none prof-locked">
                            </div>
                        </div>
                    </div>

                    <div>
                        <h4 class="font-bold text-[#03045e] text-sm border-b pb-2 mb-4">Información Complementaria</h4>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Dirección de Residencia</label>
                                <input type="text" class="w-full border p-2 rounded text-sm focus:border-[#03045e] focus:outline-none" value="Calle Principal #123">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">EPS Actual / Seguro de Salud</label>
                                <input type="text" class="w-full border p-2 rounded text-sm focus:border-[#03045e] focus:outline-none" value="Sanitas EPS">
                            </div>
                        </div>
                    </div>

                    <div class="pt-4 border-t flex justify-end gap-2 mt-6">
                        <button type="button" onclick="document.getElementById('profileModal').classList.add('hidden')" class="px-4 py-2 border rounded text-sm font-bold text-gray-600 hover:bg-gray-50">Cerrar</button>
                        <button type="button" onclick="saveProfileAndClose()" class="px-6 py-2 bg-[#03045e] text-white rounded text-sm font-bold hover:bg-black transition">Guardar Cambios</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <div id="certModal" class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-lg overflow-hidden flex flex-col">
            <div class="bg-[#0077b6] p-4 flex justify-between items-center text-white">
                <h3 class="font-bold flex items-center gap-2"><i data-lucide="award" class="w-5 h-5"></i> Solicitar Certificado Académico</h3>
                <button onclick="closeCertModal()" class="text-blue-100 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6">
                <div class="bg-blue-50 border border-blue-200 text-blue-800 p-3 rounded text-sm mb-4">
                    <strong>Beneficio de Movilidad:</strong> Al tener una movilidad en estado ACTIVO, la expedición de estos certificados tiene un valor de $0 COP por única vez.
                </div>
                <form id="certForm" class="space-y-4">
                    <input type="hidden" id="certReqId">
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Tipo de Certificado Requerido</label>
                        <select id="certType" class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none">
                            <option value="">Seleccione el certificado...</option>
                            <option value="Certificado de Notas ">Certificado de Notas </option>
                            <option value="Certificado de Estudio ">Certificado de Estudio</option>
                            <option value="Certificado de Estudio (educontinua)">Certificado de Estudio educontinua</option>
                            <option value="Certificado de Buena Conducta">Certificado de Buena Conducta</option>
                            <option value="Contenido programático ">Contenidos Programático (profesional)</option>
                             <option value="otro">Otros documentos</option>
                        </select>
                    </div>
                    <div>
                        <label class="block text-xs font-bold text-gray-600 uppercase mb-1">Observaciones Generales</label>
                        <textarea id="certObs" rows="3" class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none" placeholder="Indique detalles adicionales..."></textarea>
                    </div>
                    <div class="flex justify-between items-center bg-gray-50 p-3 rounded border">
                        <span class="text-sm font-bold text-gray-600 uppercase">Total a Pagar:</span>
                        <span class="text-lg font-bold text-green-700">$ 0 COP</span>
                    </div>
                    <div class="flex justify-end gap-3 pt-4 border-t">
                        <button type="button" onclick="closeCertModal()" class="px-4 py-2 border rounded text-gray-600 text-sm font-bold">Cancelar</button>
                        <button type="button" onclick="confirmCertRequest()" class="px-6 py-2 bg-[#0077b6] text-white rounded text-sm font-bold">Generar Ticket</button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const currentUser = AuthService.checkAuth();
            document.getElementById('userNameDisplay').textContent = currentUser.name;
            document.getElementById('userRoleDisplay').textContent = currentUser.role.name;

            const tbody = document.getElementById('requestsTableBody');
            
            const mockRequests = [
                { id: 'REQ-1082', date: '18/02/2026', type: 'Práctica Empresarial', dest: 'Software SAS', status: 'EN_REVISION_POSTULACION', userEmail: 'estudiante@cue.edu.co' },
                { id: 'REQ-1002', date: '10/01/2026', type: 'Intercambio Académico', dest: 'UNAM (México)', status: 'APROBADA_POSTULACION', userEmail: 'estudiante@cue.edu.co' },
                { id: 'REQ-0550', date: '05/08/2025', type: 'Curso Corto', dest: 'Universidad de los Andes', status: 'MOVILIDAD_ACTIVA', userEmail: 'estudiante@cue.edu.co' },
                { id: 'REQ-0998', date: '01/11/2025', type: 'Visita/Salida Académica', dest: 'Planta de Producción', status: 'MOVILIDAD_ACTIVA', userEmail: 'docente@cue.edu.co' },
                { id: 'REQ-2005', date: '15/02/2026', type: 'Intercambio Académico', dest: 'CUE Alexander von Humboldt', status: 'EN_REVISION_TOTAL', userEmail: 'externo@unam.mx' }
            ];

            const localReqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            const allReqs = [...mockRequests, ...localReqs];
            const userReqs = allReqs.filter(req => req.userEmail === currentUser.email);

            tbody.innerHTML = '';

            if (userReqs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="5" class="p-8 text-center text-gray-500 italic">Aún no tienes trámites de movilidad registrados.</td></tr>`;
            } else {
                userReqs.forEach(req => {
                    let statusConfig = getStatusConfig(req.status, req.id, currentUser);
                    tbody.innerHTML += `
                        <tr class="hover:bg-gray-50 border-b last:border-0 transition">
                            <td class="p-4 font-mono font-bold text-[#03045e]">${req.id}</td>
                            <td class="p-4">
                                <span class="font-bold text-gray-800 block">${req.type}</span>
                                <span class="text-xs text-gray-500 flex items-center gap-1 mt-1"><i data-lucide="map-pin" class="w-3 h-3"></i> ${req.dest || 'Por definir'}</span>
                            </td>
                            <td class="p-4 text-gray-600">${req.date}</td>
                            <td class="p-4">
                                <span class="px-2 py-1 rounded text-xs font-bold border ${statusConfig.badgeClass}">${statusConfig.label}</span>
                            </td>
                            <td class="p-4 text-center align-middle">
                                ${statusConfig.actionHtml}
                            </td>
                        </tr>
                    `;
                });
            }
            lucide.createIcons();
        });

        function getStatusConfig(status, id, currentUser) {
            const isExterno = currentUser && currentUser.role && currentUser.role.code === 'EXTERNO';
            const certBtn = (id, green) => isExterno ? '' : `<button onclick="solicitarCertificado('${id}')" class="${green ? 'border border-green-600 text-green-600 hover:bg-green-50' : 'border border-[#0077b6] text-[#0077b6] hover:bg-blue-50'} px-3 py-1 rounded text-xs font-bold transition">Pedir Certificado</button>`;
            let config = { badgeClass: 'bg-gray-100 text-gray-600 border-gray-200', label: status, actionHtml: '<span class="text-xs text-gray-400 italic">En proceso...</span>' };
            switch(status) {
                case 'EN_REVISION_POSTULACION':
                case 'EN_REVISION_SECRETARIA_ANI':
                case 'EN_REVISION_DIRECCION_ANI':
                case 'EN_REVISION_TOTAL':
                case 'PENDIENTE_MATRICULA':
                    config.badgeClass = 'bg-yellow-100 text-yellow-800 border-yellow-200';
                    config.label = 'En Revisión Inicial';
                    break;
                case 'APROBADA_POSTULACION':
                    config.badgeClass = 'bg-orange-100 text-orange-800 border-orange-200';
                    config.label = 'Aprobada / Requiere Anexos';
                    config.actionHtml = `
                        <div class="flex flex-col gap-1">
                            <a href="mobility-wizard.html?mode=docs&id=${id}" class="inline-block bg-[#0077b6] text-white px-3 py-1 rounded text-xs font-bold hover:bg-[#03045e] transition text-center">Fase 2: Adjuntar Docs</a>
                            ${certBtn(id, false)}
                        </div>`;
                    break;
                case 'EN_REVISION_LEGALIZACION':
                    config.badgeClass = 'bg-blue-100 text-blue-800 border-blue-200';
                    config.label = 'En Legalización';
                    config.actionHtml = certBtn(id, false);
                    break;
                case 'MOVILIDAD_ACTIVA':
                    config.badgeClass = 'bg-green-100 text-green-800 border-green-200';
                    config.label = 'Activa / Vigente';
                    config.actionHtml = certBtn(id, true);
                    break;
            }
            return config;
        }

        function saveProfileAndClose() {
            const profile = {
                docNumber: document.getElementById('profNumDoc')?.value?.trim() || '',
                semester: document.getElementById('profSemestre')?.value?.trim() || '',
                promedio: document.getElementById('profPromedio')?.value?.trim() || '',
                nombres: document.getElementById('profNombres')?.value?.trim() || '',
                apellidos: document.getElementById('profApellidos')?.value?.trim() || ''
            };
            try { localStorage.setItem('CUE_USER_PROFILE', JSON.stringify(profile)); } catch (e) {}
            alert('Perfil actualizado exitosamente en el sistema.');
            document.getElementById('profileModal').classList.add('hidden');
        }
        function openReqsModal() { document.getElementById('reqsModal').classList.remove('hidden'); }
        function openProfileModal() { 
            const currentUser = AuthService.checkAuth();
            const alertBox = document.getElementById('profileAlertBox');
            const lockedFields = document.querySelectorAll('.prof-locked');
            const extRoleCont = document.getElementById('extRoleContainer');
            
            // Lógica de visualización basada en el rol del usuario (Interno vs Externo)
            if (currentUser.role.code === 'EXTERNO') {
                alertBox.className = "text-sm p-3 rounded mb-6 border bg-blue-50 border-blue-200 text-blue-800";
                alertBox.innerHTML = "<strong>Bienvenido(a).</strong> Por favor, complete todos sus datos personales y académicos para continuar con sus solicitudes de movilidad entrante.";
                
                extRoleCont.classList.remove('hidden');
                
                // Habilitar campos para edición
                lockedFields.forEach(field => {
                    field.readOnly = false;
                    if(field.tagName === 'SELECT') field.disabled = false;
                    field.classList.remove('bg-gray-100', 'cursor-not-allowed', 'text-gray-500');
                    field.classList.add('focus:border-[#03045e]', 'bg-white');
                });
            } else {
                alertBox.className = "text-sm p-3 rounded mb-6 border bg-yellow-50 border-yellow-200 text-yellow-800";
                alertBox.innerHTML = "<strong>Nota Informativa:</strong> Sus datos personales y académicos son administrados directamente por Control y Registro. Si requiere actualizarlos, por favor realice la gestión directamente en el <strong>Portal CUE (Q10)</strong>.";
                
                extRoleCont.classList.add('hidden');
                
                // Bloquear campos de solo lectura
                lockedFields.forEach(field => {
                    field.readOnly = true;
                    if(field.tagName === 'SELECT') field.disabled = true;
                    field.classList.add('bg-gray-100', 'cursor-not-allowed', 'text-gray-500');
                    field.classList.remove('focus:border-[#03045e]', 'bg-white');
                });

                // Simulación de carga de datos desde Q10
                document.getElementById('profNombres').value = currentUser.name.split(' ')[0];
                document.getElementById('profApellidos').value = "Ocampo Hurtado";
                document.getElementById('profNumDoc').value = "1094000000";
                document.getElementById('profCelular').value = "3001234567";
                document.getElementById('profSemestre').value = "5";
                document.getElementById('profPromedio').value = "4.2";
                document.getElementById('profNacionalidad').value = "Colombiana";
                document.getElementById('profTipoDoc').value = "CC";
            }
            
            document.getElementById('profileModal').classList.remove('hidden'); 
        }
        
        function solicitarCertificado(id) {
            document.getElementById('certReqId').value = id;
            document.getElementById('certForm').reset();
            document.getElementById('certModal').classList.remove('hidden');
        }
        function closeCertModal() { document.getElementById('certModal').classList.add('hidden'); }

        function confirmCertRequest() {
            const reqId = document.getElementById('certReqId').value;
            const certType = document.getElementById('certType').value;
            if(!certType) return alert("Seleccione un tipo de certificado.");
            
            let reqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            reqs = reqs.map(req => {
                if (req.id === reqId) {
                    req.certRequested = true; req.certType = certType; req.certStatus = 'PAGADO';
                }
                return req;
            });
            localStorage.setItem('CUE_MY_REQUESTS', JSON.stringify(reqs));
            alert("Ticket generado. Estado: PAGADO ($0). Enviado a Registro Académico.");
            closeCertModal();
        }
    </script>
</body>
</html>