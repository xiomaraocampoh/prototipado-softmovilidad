<!DOCTYPE html>
<html lang="es">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Gesti√≥n ANI - CUE Movilidad</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="../assets/css/style.css">
    <script src="https://unpkg.com/lucide@latest"></script>
</head>

<body class="bg-[#f0f4f8] font-['Inter'] flex h-screen overflow-hidden">

    <aside class="w-64 bg-[#03045e] text-white flex flex-col hidden md:flex shadow-xl z-20">
        <div class="h-16 flex items-center px-6 border-b border-white/10">
            <h1 class="font-bold text-lg tracking-wide" id="aniTitle">Oficina ANI</h1>
        </div>

        <div class="p-6 pb-2">
            <p class="text-[10px] text-blue-300 uppercase font-bold tracking-wider mb-2">Men√∫ Principal</p>
        </div>

        <nav class="flex-1 px-4 space-y-2 overflow-y-auto">
            <button onclick="switchTab('tab-bandeja')"
                class="ani-tab w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left bg-white/10 text-white font-bold transition"
                data-target="tab-bandeja">
                <i data-lucide="inbox" class="w-4 h-4"></i> Bandeja Documental
            </button>
            <button onclick="switchTab('tab-convenios')"
                class="ani-tab w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-blue-200 hover:bg-white/5 hover:text-white font-semibold transition"
                data-target="tab-convenios">
                <i data-lucide="building" class="w-4 h-4"></i> Gesti√≥n Convenios
            </button>
            <button onclick="switchTab('tab-credenciales')"
                class="ani-tab w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-blue-200 hover:bg-white/5 hover:text-white font-semibold transition"
                data-target="tab-credenciales">
                <i data-lucide="users" class="w-4 h-4"></i> Accesos Externos
            </button>
            <button onclick="switchTab('tab-programas')"
                class="ani-tab w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-blue-200 hover:bg-white/5 hover:text-white font-semibold transition"
                data-target="tab-programas">
                <i data-lucide="book-open" class="w-4 h-4"></i> Programas
            </button>
            <button onclick="switchTab('tab-tipos')"
                class="ani-tab w-full flex items-center gap-3 px-3 py-2.5 rounded-lg text-left text-blue-200 hover:bg-white/5 hover:text-white font-semibold transition"
                data-target="tab-tipos">
                <i data-lucide="settings" class="w-4 h-4"></i> Tipos Movilidad
            </button>
        </nav>

        <div class="p-4 border-t border-white/10">
            <button onclick="AuthService.logout()"
                class="w-full flex items-center justify-center gap-2 px-3 py-2 text-sm text-blue-200 hover:text-white hover:bg-red-600/80 rounded transition">
                <i data-lucide="log-out" class="w-4 h-4"></i> Cerrar Sesi√≥n
            </button>
        </div>
    </aside>

    <div class="flex-1 flex flex-col h-screen overflow-hidden">

        <nav class="bg-white border-b shadow-sm h-16 flex justify-between items-center px-6 z-10 shrink-0">
            <div class="flex items-center gap-3">
                <img src="../assets/img/logo_avh.png" alt="Logo CUE" class="h-10">
                <span class="text-[#0077b6] font-bold border-l pl-3 ml-2 text-sm">M√≥dulo Administrativo</span>
            </div>
            <div class="flex items-center gap-4">
                <div class="text-right">
                    <p id="userNameDisplay" class="text-sm font-bold text-[#03045e] leading-tight">Usuario</p>
                    <p id="userRoleDisplay" class="text-[10px] text-gray-500 uppercase font-bold">Rol</p>
                </div>
            </div>
        </nav>

        <main class="flex-1 overflow-y-auto p-6 md:p-8 bg-[#f0f4f8]">

            <div id="tab-bandeja" class="ani-content-section block animate-fade-in">
                <div class="flex justify-between items-end mb-6">
                    <div>
                        <h2 class="text-2xl font-bold text-[#03045e]">Bandeja de Revisi√≥n Documental</h2>
                        <p class="text-gray-500 text-sm">Evaluaci√≥n de expedientes y solicitudes radicadas.</p>
                    </div>
                </div>
                <div class="bg-white rounded-xl shadow-sm border border-gray-200 overflow-hidden">
                    <div class="overflow-x-auto">
                        <table class="w-full text-left border-collapse">
                            <thead class="bg-gray-50 border-b border-gray-200 text-xs uppercase text-gray-500 font-bold">
                                <tr>
                                    <th class="p-4 w-24">ID</th>
                                    <th class="p-4">Solicitante</th>
                                    <th class="p-4">Tipo Movilidad</th>
                                    <th class="p-4 text-center">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="aniTableBody" class="divide-y divide-gray-100 text-sm">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-convenios" class="ani-content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-[#03045e]">Gesti√≥n de Convenios</h2>
                    <p class="text-gray-500 text-sm">Administre las instituciones y fechas de vigencia.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border md:col-span-1 h-fit">
                        <h4 class="font-bold text-[#03045e] border-b pb-2 mb-4">Nuevo Convenio</h4>
                        <form id="formConvenio" class="space-y-4" onsubmit="return saveConvenio(event);">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Instituci√≥n</label>
                                <input type="text" id="convNombre" placeholder="Ej: Universidad de Lima" required
                                    class="w-full border p-2 rounded text-sm focus:outline-none focus:border-[#0077b6]">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Pa√≠s</label>
                                <input type="text" id="convPais" placeholder="Ej: Per√∫" required
                                    class="w-full border p-2 rounded text-sm focus:outline-none focus:border-[#0077b6]">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Ciudad</label>
                                <input type="text" id="convCiudad" placeholder="Ej: Lima" required
                                    class="w-full border p-2 rounded text-sm focus:outline-none focus:border-[#0077b6]">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Fecha de Vigencia</label>
                                <input type="date" id="convVigencia" required
                                    class="w-full border p-2 rounded text-sm focus:outline-none focus:border-[#0077b6]">
                            </div>
                            <button type="submit"
                                class="w-full bg-[#0077b6] text-white py-2 rounded text-sm font-bold hover:bg-[#03045e] transition">Guardar
                                Convenio</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border md:col-span-2 overflow-hidden">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 border-b text-xs text-gray-500 uppercase">
                                <tr>
                                    <th class="p-4">Instituci√≥n</th>
                                    <th class="p-4">Vigencia</th>
                                    <th class="p-4 text-center">Estado</th>
                                </tr>
                            </thead>
                            <tbody id="conveniosTableBody" class="divide-y">
                                <!-- Cargado desde CUE_CONVENIOS (localStorage) -->
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-credenciales" class="ani-content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-[#03045e]">Generaci√≥n de Credenciales (Externos)</h2>
                    <p class="text-gray-500 text-sm">Cree cuentas temporales para solicitantes de movilidad entrante (REQ-08).</p>
                </div>
                <div class="bg-white p-6 rounded-xl shadow-sm border max-w-xl">
                    <form id="formCredencialesExterno" onsubmit="return generarAccesoExterno(event);" class="space-y-4">
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Nombre completo <span class="text-red-600">*</span></label>
                            <input type="text" id="extName" required placeholder="Ej: Carlos M√©ndez L√≥pez"
                                class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Correo electr√≥nico <span class="text-red-600">*</span></label>
                            <input type="email" id="extEmail" required placeholder="Para env√≠o de clave"
                                class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Instituci√≥n de origen <span class="text-red-600">*</span></label>
                            <input type="text" id="extInst" required placeholder="Ej: UNAM"
                                class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none">
                        </div>
                        <div>
                            <label class="block text-xs font-bold text-gray-600 mb-1">Documento de identidad <span class="text-red-600">*</span></label>
                            <input type="text" id="extDoc" required placeholder="N√∫mero de documento o pasaporte"
                                class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none">
                        </div>
                        <div class="grid grid-cols-1 md:grid-cols-2 gap-4">
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Fecha de inicio del acceso <span class="text-red-600">*</span></label>
                                <input type="date" id="extFecInicio" required
                                    class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-600 mb-1">Fecha de fin del acceso <span class="text-red-600">*</span></label>
                                <input type="date" id="extFecFin" required
                                    class="w-full border p-2 rounded text-sm focus:border-[#0077b6] focus:outline-none">
                            </div>
                        </div>
                        <button type="submit"
                            class="w-full bg-[#03045e] text-white py-3 rounded text-sm font-bold flex justify-center items-center gap-2 hover:bg-black transition">
                            <i data-lucide="mail-send" class="w-4 h-4"></i> Generar y Enviar Acceso
                        </button>
                    </form>
                </div>
            </div>

            <div id="tab-programas" class="ani-content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-[#03045e]">Programas Acad√©micos (REQ-09)</h2>
                    <p class="text-gray-500 text-sm">Gesti√≥n de programas y correo del coordinador para la bandeja de Paz y Salvo.</p>
                </div>
                <div class="grid grid-cols-1 md:grid-cols-3 gap-6">
                    <div class="bg-white p-5 rounded-xl shadow-sm border md:col-span-1 h-fit">
                        <h4 class="font-bold text-[#03045e] border-b pb-2 mb-4">Agregar Programa</h4>
                        <form id="formPrograma" class="space-y-4" onsubmit="return agregarProgramaANI(event);">
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Nombre del Programa <span class="text-red-600">*</span></label>
                                <input type="text" id="progNombre" placeholder="Ej: Ingenier√≠a de Software" required
                                    class="w-full border p-2 rounded text-sm focus:outline-none focus:border-[#0077b6]">
                            </div>
                            <div>
                                <label class="block text-xs font-bold text-gray-500 mb-1">Correo del Coordinador Acad√©mico <span class="text-red-600">*</span></label>
                                <input type="email" id="progCorreoCoord" placeholder="Ej: coord.software@cue.edu.co" required
                                    class="w-full border p-2 rounded text-sm focus:outline-none focus:border-[#0077b6]">
                            </div>
                            <button type="submit" class="w-full bg-[#0077b6] text-white py-2 rounded text-sm font-bold hover:bg-[#03045e] transition">Guardar Programa</button>
                        </form>
                    </div>
                    <div class="bg-white rounded-xl shadow-sm border overflow-hidden md:col-span-2">
                        <table class="w-full text-left text-sm">
                            <thead class="bg-gray-50 border-b text-xs text-gray-500 uppercase">
                                <tr>
                                    <th class="p-4">Programa</th>
                                    <th class="p-4">Correo Coordinador</th>
                                    <th class="p-4 text-center w-24">Acci√≥n</th>
                                </tr>
                            </thead>
                            <tbody id="programasTableBody" class="divide-y divide-gray-100">
                            </tbody>
                        </table>
                    </div>
                </div>
            </div>

            <div id="tab-tipos" class="ani-content-section hidden animate-fade-in">
                <div class="mb-6">
                    <h2 class="text-2xl font-bold text-[#03045e]">Configuraci√≥n de Movilidades</h2>
                    <p class="text-gray-500 text-sm">Habilite o pause los tipos de movilidad ofertados en el formulario.
                    </p>
                </div>
                <div class="bg-white rounded-xl shadow-sm border overflow-hidden max-w-4xl">
                    <table class="w-full text-left text-sm">
                        <thead class="bg-gray-50 border-b text-xs text-gray-500 uppercase">
                            <tr>
                                <th class="p-4">Tipo de Movilidad</th>
                                <th class="p-4 text-center">Estado Actual</th>
                                <th class="p-4 text-center">Acci√≥n</th>
                            </tr>
                        </thead>
                        <tbody class="divide-y">
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-bold text-[#03045e]">Intercambio Acad√©mico</td>
                                <td class="p-4 text-center"><span
                                        class="bg-green-100 text-green-800 px-3 py-1 rounded-full text-xs font-bold">Habilitado</span>
                                </td>
                                <td class="p-4 text-center"><button
                                        class="text-orange-600 font-bold text-xs border border-orange-200 px-3 py-1 rounded hover:bg-orange-50">Pausar</button>
                                </td>
                            </tr>
                            <tr class="hover:bg-gray-50">
                                <td class="p-4 font-bold text-[#03045e]">Voluntariado</td>
                                <td class="p-4 text-center"><span
                                        class="bg-gray-100 text-gray-500 px-3 py-1 rounded-full text-xs font-bold">Suspendido</span>
                                </td>
                                <td class="p-4 text-center"><button
                                        class="text-green-600 font-bold text-xs border border-green-200 px-3 py-1 rounded hover:bg-green-50">Habilitar</button>
                                </td>
                            </tr>
                        </tbody>
                    </table>
                </div>
            </div>

        </main>
    </div>

    <div id="reviewModal"
        class="hidden fixed inset-0 bg-black/50 z-50 flex items-center justify-center backdrop-blur-sm p-4">
        <div class="bg-white rounded-xl shadow-2xl w-full max-w-3xl max-h-[90vh] overflow-hidden flex flex-col">
            <div class="bg-[#03045e] p-4 flex justify-between items-center text-white shrink-0">
                <h3 class="font-bold flex items-center gap-2"><i data-lucide="clipboard-check" class="w-5 h-5"></i>
                    Evaluar Expediente (FO-IN-012)</h3>
                <button onclick="document.getElementById('reviewModal').classList.add('hidden')"
                    class="text-gray-300 hover:text-white"><i data-lucide="x" class="w-5 h-5"></i></button>
            </div>
            <div class="p-6 overflow-y-auto flex-1">
                <div class="grid grid-cols-2 gap-4 mb-4 text-sm">
                    <div class="bg-gray-50 p-3 rounded border"><span class="block text-[10px] font-bold text-gray-400 uppercase">ID Solicitud</span><span class="font-mono font-bold text-[#03045e]" id="modalId"></span></div>
                    <div class="bg-gray-50 p-3 rounded border"><span class="block text-[10px] font-bold text-gray-400 uppercase">Solicitante</span><span class="font-bold text-gray-800" id="modalUser"></span></div>
                </div>
                <div id="modalExpedienteContent" class="text-sm space-y-4 mb-6">
                    <!-- Contenido din√°mico: datos FO-IN-012 completos (REQ-10) -->
                </div>
                <div id="modalDocsContent" class="text-sm space-y-3 mb-6">
                    <!-- REQ-XX: Lista de documentos cargados / simulados para revisi√≥n individual -->
                </div>
                <div id="modalActions" class="flex justify-end gap-3 pt-4 border-t"></div>
            </div>
        </div>
    </div>

    <script src="../assets/js/auth.js"></script>
    <script>
        let currentRole = null;
        let currentRequestId = null;

        document.addEventListener('DOMContentLoaded', () => {
            const user = AuthService.checkAuth({ redirectTo: '../index-sistema.html' });
            if (!user || (user.role.code !== 'ANI_SECRETARIA' && user.role.code !== 'ANI_DIRECCION')) {
                alert("Acceso denegado."); window.location.href = '../index-sistema.html'; return;
            }
            currentRole = user.role.code;
            document.getElementById('userNameDisplay').textContent = user.name;
            document.getElementById('userRoleDisplay').textContent = user.role.name;
            document.getElementById('aniTitle').textContent = user.role.code === 'ANI_SECRETARIA' ? 'Secretar√≠a ANI' : 'Direcci√≥n ANI';

            loadTable();
            loadConveniosTable();
            lucide.createIcons();
        });

        // ==========================================
        // CONVENIOS (RF-11): persistencia en CUE_CONVENIOS
        // ==========================================
        const LS_CONVENIOS = 'CUE_CONVENIOS';

        function getConvenios() {
            try {
                const raw = localStorage.getItem(LS_CONVENIOS);
                if (!raw) return [];
                const data = JSON.parse(raw);
                return Array.isArray(data) ? data : [];
            } catch {
                return [];
            }
        }

        function saveConvenio(e) {
            e.preventDefault();
            const nombre = document.getElementById('convNombre').value.trim();
            const pais = document.getElementById('convPais').value.trim();
            const ciudad = document.getElementById('convCiudad').value.trim();
            const vigencia = document.getElementById('convVigencia').value;
            if (!nombre || !pais || !ciudad || !vigencia) {
                alert('Complete todos los campos del convenio.');
                return false;
            }
            const convenios = getConvenios();
            convenios.push({ nombre, pais, ciudad, vigencia });
            localStorage.setItem(LS_CONVENIOS, JSON.stringify(convenios));
            document.getElementById('formConvenio').reset();
            loadConveniosTable();
            alert('Convenio registrado correctamente.');
            return false;
        }

        function loadConveniosTable() {
            const tbody = document.getElementById('conveniosTableBody');
            if (!tbody) return;
            let convenios = getConvenios();
            if (convenios.length === 0) {
                convenios = [
                    { nombre: 'UNAM', pais: 'M√©xico', ciudad: 'CDMX', vigencia: '2027-12-31' },
                    { nombre: 'DHBW Ravensburg', pais: 'Alemania', ciudad: 'Ravensburg', vigencia: '2023-12-31' }
                ];
                localStorage.setItem(LS_CONVENIOS, JSON.stringify(convenios));
            }
            const formatDate = (str) => {
                if (!str) return 'N/A';
                const d = new Date(str);
                return isNaN(d.getTime()) ? str : d.toLocaleDateString('es-CO', { day: '2-digit', month: '2-digit', year: 'numeric' });
            };
            tbody.innerHTML = convenios.map(c => {
                const isExp = new Date(c.vigencia) < new Date();
                const estadoClass = isExp ? 'bg-red-100 text-red-800' : 'bg-green-100 text-green-800';
                const estadoTxt = isExp ? 'Vencido' : 'Activo';
                return `<tr class="hover:bg-gray-50">
                    <td class="p-4 font-bold text-[#03045e]">${escapeHtml(c.nombre)}</td>
                    <td class="p-4 text-gray-600">${formatDate(c.vigencia)}</td>
                    <td class="p-4 text-center"><span class="${estadoClass} px-2 py-1 rounded text-xs font-bold">${estadoTxt}</span></td>
                </tr>`;
            }).join('');
        }

        function escapeHtml(str) {
            return String(str == null ? '' : str)
                .replace(/&/g, '&amp;').replace(/</g, '&lt;').replace(/>/g, '&gt;').replace(/"/g, '&quot;');
        }

        // L√≥gica del Sidebar y Pesta√±as
        function switchTab(targetId) {
            // Ocultar todas las secciones
            document.querySelectorAll('.ani-content-section').forEach(el => el.classList.add('hidden'));
            document.getElementById(targetId).classList.remove('hidden');

            // Restablecer estilos de botones en el sidebar
            document.querySelectorAll('.ani-tab').forEach(el => {
                el.classList.remove('bg-white/10', 'text-white', 'font-bold');
                el.classList.add('text-blue-200', 'font-semibold');
            });

            // Aplicar estilo activo
            const activeBtn = document.querySelector(`[data-target="${targetId}"]`);
            if (activeBtn) {
                activeBtn.classList.remove('text-blue-200', 'font-semibold');
                activeBtn.classList.add('bg-white/10', 'text-white', 'font-bold');
            }
        }

        function loadTable() {
            const tbody = document.getElementById('aniTableBody');
            tbody.innerHTML = '';

            const mockRequests = [
                { id: 'REQ-1082', type: 'Pr√°ctica Empresarial', status: 'EN_REVISION_SECRETARIA_ANI', userEmail: 'estudiante@cue.edu.co', dir: 'SALIENTE' },
                { id: 'REQ-2005', type: 'Intercambio Acad√©mico', status: 'EN_REVISION_TOTAL', userEmail: 'externo@unam.mx', dir: 'ENTRANTE' }
            ];

            const localReqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            const allReqs = [...mockRequests];
            localReqs.forEach(lr => { if (!allReqs.find(ar => ar.id === lr.id)) allReqs.push(lr); });

            const visibleReqs = allReqs.filter(req => {
                if (currentRole === 'ANI_SECRETARIA') return req.status === 'EN_REVISION_SECRETARIA_ANI';
                if (currentRole === 'ANI_DIRECCION') return req.status === 'EN_REVISION_DIRECCION_ANI' || req.status === 'EN_REVISION_TOTAL';
                return false;
            });

            if (visibleReqs.length === 0) {
                tbody.innerHTML = `<tr><td colspan="4" class="p-8 text-center text-gray-500">
                    <div class="flex flex-col items-center gap-2">
                        <span class="text-4xl opacity-50">üìÇ</span>
                        <p class="font-medium">No hay expedientes pendientes de revisi√≥n</p>
                        <p class="text-xs">Las solicitudes radicadas aparecer√°n aqu√≠ seg√∫n su rol (Secretar√≠a o Direcci√≥n).</p>
                    </div>
                </td></tr>`;
                return;
            }

            visibleReqs.forEach(req => {
                const safeId = String(req.id || '').replace(/\\/g, '\\\\').replace(/'/g, "\\'");
                tbody.innerHTML += `
                    <tr class="hover:bg-blue-50 transition border-b">
                        <td class="p-4 font-mono font-bold text-[#03045e]">${escapeHtml(req.id)}</td>
                        <td class="p-4">${escapeHtml(req.userEmail)}</td>
                        <td class="p-4">${escapeHtml(req.type)}</td>
                        <td class="p-4 text-center">
                            <button onclick="openReviewById('${safeId}')" class="border border-[#0077b6] text-[#0077b6] px-4 py-1.5 rounded text-xs font-bold hover:bg-blue-50 transition">Evaluar Expediente</button>
                        </td>
                    </tr>
                `;
            });
        }

        function openReviewById(id) {
            const allReqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            const req = allReqs.find(r => r.id === id);
            openReview(req || { id: id, userEmail: id, type: '', dir: 'SALIENTE' });
        }

        function buildExpedienteHtml(req) {
            const ed = req.expedienteData || {};
            const ext = req.externoFOIN012 || {};
            const isExterno = !!req.externoFOIN012;
            const v = (val) => (val === undefined || val === null || val === '') ? '‚Äî' : String(val);

            let html = '';

            html += '<div class="border rounded-lg p-4 bg-gray-50"><h4 class="font-bold text-[#03045e] text-xs uppercase mb-3">Movilidad y destino</h4><div class="grid grid-cols-2 gap-2 text-sm">';
            html += '<div><span class="text-gray-500">Tipo</span><br>' + v(ed.tipo) + '</div>';
            html += '<div><span class="text-gray-500">Direcci√≥n</span><br>' + v(ed.direccion) + '</div>';
            html += '<div><span class="text-gray-500">Instituci√≥n destino</span><br>' + v(ed.institucionDestino) + (ed.otraEntidad ? ' / ' + v(ed.otraEntidad) : '') + '</div>';
            html += '<div><span class="text-gray-500">Pa√≠s / Ciudad</span><br>' + v(ed.pais) + ' / ' + v(ed.ciudad) + '</div>';
            html += '<div><span class="text-gray-500">Fechas</span><br>' + v(ed.fechaInicio) + ' ‚Äì ' + v(ed.fechaFin) + '</div>';
            html += '<div><span class="text-gray-500">Duraci√≥n</span><br>' + v(ed.duracion) + '</div>';
            html += '<div class="col-span-2"><span class="text-gray-500">Actividades / materias</span><br>' + v(ed.actividadesDesc) + '</div></div></div>';

            html += '<div class="border rounded-lg p-4 bg-gray-50"><h4 class="font-bold text-[#03045e] text-xs uppercase mb-3">Datos personales y documento</h4><div class="grid grid-cols-2 gap-2 text-sm">';
            if (isExterno) {
                html += '<div><span class="text-gray-500">Primer nombre</span><br>' + v(ext.primerNombre) + '</div><div><span class="text-gray-500">Segundo nombre</span><br>' + v(ext.segundoNombre) + '</div>';
                html += '<div><span class="text-gray-500">Primer apellido</span><br>' + v(ext.primerApellido) + '</div><div><span class="text-gray-500">Segundo apellido</span><br>' + v(ext.segundoApellido) + '</div>';
                html += '<div><span class="text-gray-500">Sexo</span><br>' + v(ext.sexo) + '</div><div><span class="text-gray-500">Direcci√≥n</span><br>' + v(ext.direccion) + '</div>';
                html += '<div><span class="text-gray-500">Departamento</span><br>' + v(ext.departamento) + '</div><div><span class="text-gray-500">Municipio</span><br>' + v(ext.municipio) + '</div>';
                html += '<div><span class="text-gray-500">Tipo doc</span><br>' + v(ext.tipoDoc) + '</div><div><span class="text-gray-500">N√∫mero doc</span><br>' + v(ext.numDoc) + '</div>';
                html += '<div><span class="text-gray-500">Celular</span><br>' + v(ext.celular) + '</div><div><span class="text-gray-500">Correo</span><br>' + v(ext.correo) + '</div>';
            } else {
                html += '<div><span class="text-gray-500">Documento</span><br>' + v(ed.documento) + '</div><div><span class="text-gray-500">Programa</span><br>' + v(ed.programa) + '</div>';
                html += '<div><span class="text-gray-500">Semestre / Promedio</span><br>' + v(ed.semestrePromedio) + '</div>';
            }
            html += '</div></div>';

            html += '<div class="border rounded-lg p-4 bg-gray-50"><h4 class="font-bold text-[#03045e] text-xs uppercase mb-3">Costos, apoyos y becas</h4><div class="grid grid-cols-2 gap-2 text-sm">';
            html += '<div><span class="text-gray-500">Costo matr√≠cula</span><br>' + v(ed.hasCosto) + (ed.montoCosto ? ' ‚Äì ' + ed.montoCosto : '') + '</div>';
            html += '<div><span class="text-gray-500">Beca / apoyo</span><br>' + v(ed.hasBeca) + (ed.montoBeca ? ' ‚Äì ' + ed.montoBeca : '') + '</div></div></div>';

            html += '<div class="border rounded-lg p-4 bg-gray-50"><h4 class="font-bold text-[#03045e] text-xs uppercase mb-3">Riesgos m√©dicos y contacto de emergencia</h4><div class="grid grid-cols-2 gap-2 text-sm">';
            if (isExterno) {
                html += '<div class="col-span-2"><span class="text-gray-500">Necesidades m√©dicas</span><br>' + v(ext.necesidadesMedicas) + '</div>';
                html += '<div><span class="text-gray-500">Contacto emergencia</span><br>' + v(ext.contactoNombre) + ' ' + v(ext.contactoParentesco) + '</div>';
                html += '<div><span class="text-gray-500">Tel / Correo</span><br>' + v(ext.contactoTelefono) + ' / ' + v(ext.contactoCorreo) + '</div>';
            } else {
                html += '<div><span class="text-gray-500">EPS</span><br>' + v(ed.eps) + '</div><div><span class="text-gray-500">Alergias/Meds</span><br>' + v(ed.alergiasMeds) + '</div>';
                html += '<div><span class="text-gray-500">Contacto emergencia</span><br>' + v(ed.contactoNombre) + ' ' + v(ed.contactoParentesco) + ' ' + v(ed.contactoTel) + '</div>';
            }
            html += '</div></div>';

            if (isExterno) {
                html += '<div class="border rounded-lg p-4 bg-blue-50"><h4 class="font-bold text-[#03045e] text-xs uppercase mb-3">Actividades a realizar / materias a cursar</h4><p class="text-sm">' + v(ext.actividadesMaterias) + '</p></div>';
            }
            return html;
        }

        function getRequiredDocsForReq(req) {
            const ed = req.expedienteData || {};
            const dir = req.dir || ed.direccion || 'SALIENTE';
            const type = ed.tipo || req.type || '';
            const modalidad = ed.modalidad || 'PRESENCIAL';
            const isPresencial = modalidad === 'PRESENCIAL';
            const docs = [];

            // Fase de postulaci√≥n
            docs.push({ id: 'DOC_ID', nombre: 'Documento de Identidad', desc: 'Ambas caras' });
            if (dir === 'ENTRANTE') {
                docs.push({ id: 'CARTA_POST', nombre: 'Carta de Postulaci√≥n', desc: 'Emitida por la instituci√≥n de origen' });
                docs.push({ id: 'NOTAS', nombre: 'Notas', desc: 'Certificado de calificaciones expedido por la universidad de origen' });
            } else {
                docs.push({ id: 'CARTA_MOT', nombre: 'Carta de Motivaci√≥n', desc: 'Motivos personales para la movilidad' });
            }

            // Fase de documentaci√≥n / legalizaci√≥n
            if (dir === 'SALIENTE') {
                docs.push({ id: 'CARTA_ACEPT', nombre: 'Carta de Aceptaci√≥n Oficial', desc: 'Emitida por la instituci√≥n de destino' });
            }
            if (['Pr√°ctica Empresarial - Pasant√≠a', 'Rotaci√≥n M√©dica', 'Pr√°ctica Integral'].includes(type)) {
                docs.push({ id: 'CERT_ARL', nombre: 'Certificado de ARL', desc: 'Afiliaci√≥n a Riesgos Laborales' });
            }
            if (isPresencial) {
                docs.push({ id: 'SEGURO_MED', nombre: 'Seguro M√©dico', desc: 'P√≥liza o certificado de seguro m√©dico vigente' });
                if (ed.alcance === 'INTERNACIONAL' || dir === 'ENTRANTE') {
                    docs.push({ id: 'TIQUETES_VISA', nombre: 'Tiquetes y/o Visa', desc: 'Soportes de viaje y visado cuando aplique' });
                }
            }
            return docs;
        }

        function renderDocsReview(req) {
            const container = document.getElementById('modalDocsContent');
            if (!container) return;
            const docs = getRequiredDocsForReq(req);
            if (!docs.length) {
                container.innerHTML = '<p class="text-xs text-gray-500 italic">No hay lista de documentos configurada para este tipo de movilidad.</p>';
                return;
            }
            const statusMap = req.aniDocsStatus || {};
            const badge = (st) => {
                if (st === 'APROBADO') return '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-green-100 text-green-800 border border-green-200">APROBADO</span>';
                if (st === 'RECHAZADO') return '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-red-100 text-red-800 border border-red-200">RECHAZADO</span>';
                return '<span class="px-2 py-0.5 rounded-full text-[10px] font-bold bg-gray-100 text-gray-600 border border-gray-200">PENDIENTE</span>';
            };
            container.innerHTML = docs.map(d => {
                const st = statusMap[d.id] || 'PENDIENTE';
                return `
                    <div class="border rounded-lg p-3 bg-white flex flex-col md:flex-row md:items-center md:justify-between gap-3">
                        <div>
                            <p class="text-xs font-bold text-[#03045e] uppercase mb-0.5">${escapeHtml(d.nombre)}</p>
                            <p class="text-[11px] text-gray-500">${escapeHtml(d.desc)}</p>
                        </div>
                        <div class="flex items-center gap-2">
                            ${badge(st)}
                            <button onclick="verDocumento('${req.id}', '${d.id}')" class="px-2 py-1 text-[11px] font-bold border border-gray-400 text-gray-700 rounded hover:bg-gray-50">Ver</button>
                            <button onclick="setDocDecision('${req.id}', '${d.id}', 'APROBADO')" class="px-2 py-1 text-[11px] font-bold border border-green-500 text-green-700 rounded hover:bg-green-50">Aprobar</button>
                            <button onclick="setDocDecision('${req.id}', '${d.id}', 'RECHAZADO')" class="px-2 py-1 text-[11px] font-bold border border-red-500 text-red-700 rounded hover:bg-red-50">Rechazar</button>
                        </div>
                    </div>
                `;
            }).join('');
        }

        function verDocumento(reqId, docId) {
            alert('Simulaci√≥n de apertura del documento "' + docId + '" para la solicitud ' + reqId + '. En un entorno real aqu√≠ se abrir√≠a el PDF cargado.');
        }

        function setDocDecision(reqId, docId, decision) {
            let reqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            const idx = reqs.findIndex(r => r.id === reqId);
            if (idx === -1) return;
            const req = reqs[idx];
            if (!req.aniDocsStatus) req.aniDocsStatus = {};
            req.aniDocsStatus[docId] = decision;
            reqs[idx] = req;
            localStorage.setItem('CUE_MY_REQUESTS', JSON.stringify(reqs));
            openReview(req);
        }

        function openReview(req) {
            if (!req || !req.id) return;
            currentRequestId = req.id;
            document.getElementById('modalId').textContent = req.id;
            document.getElementById('modalUser').textContent = req.userEmail || '‚Äî';

            const content = document.getElementById('modalExpedienteContent');
            content.innerHTML = req.expedienteData || req.externoFOIN012 ? buildExpedienteHtml(req) : '<p class="text-gray-500 italic">No hay datos de expediente registrados para esta solicitud.</p>';
            renderDocsReview(req);

            const actionsDiv = document.getElementById('modalActions');
            const dir = req.dir || 'SALIENTE';
            if (currentRole === 'ANI_SECRETARIA') {
                actionsDiv.innerHTML = `<button onclick="processRequest('EN_REVISION_DIRECCION_ANI')" class="px-6 py-2 bg-[#0077b6] text-white rounded text-sm font-bold hover:bg-[#03045e] transition">Pre-Aprobar (Enviar a Direcci√≥n)</button>`;
            } else {
                let btnAprobar = dir === 'ENTRANTE'
                    ? `<button onclick="processRequest('PENDIENTE_MATRICULA')" class="px-6 py-2 bg-green-600 text-white rounded text-sm font-bold hover:bg-green-700 transition">Aprobar y Enviar a Registro (Matr√≠cula)</button>`
                    : `<button onclick="processRequest('APROBADA_POSTULACION')" class="px-6 py-2 bg-[#0077b6] text-white rounded text-sm font-bold hover:bg-[#03045e] transition">Aprobar Postulaci√≥n (Pasa a Fase 2)</button>`;
                actionsDiv.innerHTML = `<button onclick="document.getElementById('reviewModal').classList.add('hidden')" class="px-4 py-2 border rounded text-gray-600 text-sm font-bold">Cancelar</button> ${btnAprobar}`;
            }
            document.getElementById('reviewModal').classList.remove('hidden');
            if (typeof lucide !== 'undefined') lucide.createIcons();
        }

        function processRequest(newStatus) {
            let reqs = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            let updated = false;
            reqs = reqs.map(req => { if (req.id === currentRequestId) { req.status = newStatus; updated = true; } return req; });
            if (!updated) reqs.push({ id: currentRequestId, status: newStatus, userEmail: document.getElementById('modalUser').textContent });
            localStorage.setItem('CUE_MY_REQUESTS', JSON.stringify(reqs));
            document.getElementById('reviewModal').classList.add('hidden');
            loadTable();
        }

        document.addEventListener('DOMContentLoaded', () => {
            if (typeof lucide !== 'undefined') lucide.createIcons();
            loadProgramasTable();
            cargarTiposMovilidad();
        });

        // ==========================================
        // REQ-08: Generaci√≥n de accesos a externos (6 campos)
        // ==========================================
        function generarAccesoExterno(e) {
            e.preventDefault();
            const nombre = (document.getElementById('extName')?.value || '').trim();
            const correo = (document.getElementById('extEmail')?.value || '').trim();
            const institucion = (document.getElementById('extInst')?.value || '').trim();
            const documento = (document.getElementById('extDoc')?.value || '').trim();
            const fecInicio = document.getElementById('extFecInicio')?.value || '';
            const fecFin = document.getElementById('extFecFin')?.value || '';

            if (!nombre || !correo || !institucion || !documento || !fecInicio || !fecFin) {
                alert("Complete todos los campos: nombre, correo, instituci√≥n, documento, fecha inicio y fecha fin del acceso.");
                return false;
            }
            if (new Date(fecFin) < new Date(fecInicio)) {
                alert("La fecha de fin del acceso debe ser posterior a la fecha de inicio.");
                return false;
            }

            const randomPassword = Math.random().toString(36).substring(2, 10);
            const msg = `Credenciales generadas y enviadas.\n\nPara: ${correo}\nNombre: ${nombre}\nInstituci√≥n: ${institucion}\nDocumento: ${documento}\nAcceso desde: ${fecInicio} hasta ${fecFin}\nUsuario: ${correo}\nContrase√±a temporal: ${randomPassword}`;
            alert(msg);
            document.getElementById('formCredencialesExterno').reset();
            return false;
        }

        // ==========================================
        // REQ-09: Programas con Nombre y Correo del Coordinador (Paz y Salvo)
        // ==========================================
        const LS_PROGRAMAS = 'CUE_PROGRAMAS';

        function getProgramas() {
            try {
                const raw = localStorage.getItem(LS_PROGRAMAS);
                if (!raw) return [];
                const data = JSON.parse(raw);
                if (!Array.isArray(data)) return [];
                return data.map(p => typeof p === 'string' ? { nombre: p, correoCoordinador: '' } : p);
            } catch { return []; }
        }

        function loadProgramasTable() {
            const tbody = document.getElementById('programasTableBody');
            if (!tbody) return;
            let programas = getProgramas();
            if (programas.length === 0) {
                programas = [
                    { nombre: 'Ingenier√≠a de Software', correoCoordinador: 'coordinacion.acad@cue.edu.co' },
                    { nombre: 'Medicina', correoCoordinador: 'coord.medicina@cue.edu.co' }
                ];
                localStorage.setItem(LS_PROGRAMAS, JSON.stringify(programas));
            }
            tbody.innerHTML = programas.map((p, i) => `
                <tr class="hover:bg-gray-50">
                    <td class="p-4 font-bold text-[#03045e]">${escapeHtml(p.nombre)}</td>
                    <td class="p-4 text-gray-600">${escapeHtml(p.correoCoordinador || '‚Äî')}</td>
                    <td class="p-4 text-center"><button onclick="eliminarProgramaANI(${i})" class="text-red-600 text-xs font-bold hover:underline">Eliminar</button></td>
                </tr>
            `).join('');
        }

        function agregarProgramaANI(e) {
            e.preventDefault();
            const nombre = (document.getElementById('progNombre')?.value || '').trim();
            const correo = (document.getElementById('progCorreoCoord')?.value || '').trim();
            if (!nombre || !correo) {
                alert('Ingrese el nombre del programa y el correo del coordinador acad√©mico.');
                return false;
            }
            let programas = getProgramas();
            programas.push({ nombre, correoCoordinador: correo });
            localStorage.setItem(LS_PROGRAMAS, JSON.stringify(programas));
            document.getElementById('formPrograma').reset();
            loadProgramasTable();
            alert('Programa agregado. El coordinador recibir√° la bandeja de Paz y Salvo.');
            return false;
        }

        function eliminarProgramaANI(index) {
            if (!confirm('¬øEliminar este programa?')) return;
            let programas = getProgramas();
            programas.splice(index, 1);
            localStorage.setItem(LS_PROGRAMAS, JSON.stringify(programas));
            loadProgramasTable();
        }

        // ==========================================
        // 3. L√ìGICA DE TIPOS DE MOVILIDAD
        // ==========================================
        function cargarTiposMovilidad() {
            const lista = document.getElementById('listaTiposMovilidad'); // Aseg√∫rate de que el ul/tbody tenga este ID
            if (!lista) return;

            // Cargar de LocalStorage o poner valores por defecto
            let tipos = JSON.parse(localStorage.getItem('CUE_TIPOS_MOVILIDAD') || '["Intercambio Acad√©mico", "Pr√°ctica Empresarial - Pasant√≠a", "Estancia Investigaci√≥n", "Diplomado"]');
            localStorage.setItem('CUE_TIPOS_MOVILIDAD', JSON.stringify(tipos));

            lista.innerHTML = tipos.map((t, index) => `
        <li class="flex justify-between items-center p-3 border-b text-sm text-gray-700 bg-white">
            <span class="font-bold">${t}</span>
            <button onclick="eliminarTipoMovilidad(${index})" class="text-red-500 hover:text-red-700" title="Eliminar Tipo">Eliminar</button>
        </li>
    `).join('');
        }

        function agregarTipoMovilidad(e) {
            e.preventDefault();
            const input = document.getElementById('nuevoTipoMovilidad'); // Aseg√∫rate de que el input tenga este ID
            if (!input || input.value.trim() === '') return;

            let tipos = JSON.parse(localStorage.getItem('CUE_TIPOS_MOVILIDAD') || '[]');
            tipos.push(input.value.trim());
            localStorage.setItem('CUE_TIPOS_MOVILIDAD', JSON.stringify(tipos));

            input.value = '';
            cargarTiposMovilidad();
            alert("Tipo de Movilidad agregado exitosamente.");
        }

        function eliminarTipoMovilidad(index) {
            if (confirm("¬øEst√° seguro de eliminar este tipo de movilidad?")) {
                let tipos = JSON.parse(localStorage.getItem('CUE_TIPOS_MOVILIDAD') || '[]');
                tipos.splice(index, 1);
                localStorage.setItem('CUE_TIPOS_MOVILIDAD', JSON.stringify(tipos));
                cargarTiposMovilidad();
            }
        }
    </script>
</body>

</html>