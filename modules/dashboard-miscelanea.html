<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <title>Solicitudes de certificados pendientes por atender</title>
    <style>
        body {
            font-family: Arial, Helvetica, sans-serif;
            background-color: #ffffff;
            margin: 20px;
            color: #000;
        }
        h1 {
            font-size: 24px;
            margin-bottom: 10px;
        }
        .btn-volver {
            background-color: #ffffff;
            border: 1px solid #cc0000;
            color: #cc0000;
            padding: 6px 14px;
            font-size: 11px;
            cursor: pointer;
            border-radius: 3px;
        }
        .btn-volver:hover {
            background-color: #ffecec;
        }
        table {
            border-collapse: collapse;
            font-size: 11px;
            margin-top: 10px;
        }
        th, td {
            border: 1px solid #0000ff;
            padding: 4px 6px;
            white-space: nowrap;
        }
        th {
            background-color: #f5f5ff;
            font-weight: bold;
        }
        .total-registros {
            margin-top: 8px;
            font-size: 11px;
        }
        .btn-cerrar {
            margin-top: 6px;
            font-size: 11px;
            padding: 3px 10px;
        }
    </style>
</head>
<body>

    <div>
        <button class="btn-volver" onclick="volverLobby()">Volver al menú</button>
    </div>

    <h1>Solicitudes de certificados pendientes por atender</h1>

    <table>
        <thead>
            <tr>
                <th>FECHA PAGO</th>
                <th>ID ESTUDIANTE</th>
                <th>NOMBRE ESTUDIANTE</th>
                <th>CELULAR</th>
                <th>CERTIFICADOS</th>
                <th>OBSERVACION</th>
                <th>O.P.</th>
                <th>VALOR PAGADO</th>
            </tr>
        </thead>
        <tbody id="tablaCertificadosBody">
        </tbody>
    </table>

    <div class="total-registros">
        Total registros: <span id="totalRegistros">0</span>
    </div>

    <button class="btn-cerrar" onclick="window.close()">Cerrar</button>

    <script>
        // 1. Verificación de Rol
        const currentUser = JSON.parse(localStorage.getItem('CUE_AUTH_USER'));
        if (!currentUser || currentUser.role.code !== 'REGISTRO') {
            window.location.href = '../index-sistema.html';
        }

        function volverLobby() {
            window.location.href = '../menu-sistema.html';
        }

        // 2. Renderizar tabla leyendo solicitudes de movilidad (certificados desde CUE_MY_REQUESTS)
        function loadCertificados() {
            const tbody = document.getElementById('tablaCertificadosBody');
            const totalSpan = document.getElementById('totalRegistros');
            tbody.innerHTML = '';

            // Tomar solicitudes de movilidad salientes con certificado pedido ($0, estado PAGADO) y movilidad activa
            let requests = JSON.parse(localStorage.getItem('CUE_MY_REQUESTS') || '[]');
            let pendientes = requests.filter(r => r.dir === 'SALIENTE' && r.certRequested === true && r.certStatus === 'PAGADO' && r.status === 'MOVILIDAD_ACTIVA');

            if (pendientes.length === 0) {
                totalSpan.textContent = '0';
                return;
            }

            pendientes.forEach(req => {
                const exp = req.expedienteData || {};
                const tr = document.createElement('tr');
                tr.innerHTML = `
                    <td>${req.date || ''}</td>
                    <td>${exp.documento || ''}</td>
                    <td>${req.userName || req.userEmail || ''}</td>
                    <td>${exp.contactoTel || ''}</td>
                    <td>${req.certType || 'Certificado Académico'}</td>
                    <td>${req.certObs || ''}</td>
                    <td>${req.id}</td>
                    <td>0</td>
                `;
                tbody.appendChild(tr);
            });

            totalSpan.textContent = pendientes.length.toString();
        }

        loadCertificados();
    </script>
</body>
</html>